<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Planilha de Pagamentos (com Firebase)</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f4f6f8; margin:0; padding:20px; }
    .container { max-width:950px; margin:auto; background:#fff; padding:20px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
    h1,h2{text-align:center}
    table{width:100%;border-collapse:collapse;margin-top:20px}
    th,td{border:1px solid #ddd;padding:10px;text-align:center}
    th{background:#f0f0f0}
    .paid{background:#d4edda;color:#155724}
    .unpaid{background:#f8d7da;color:#721c24}
    .controls{margin-top:15px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
    button{padding:6px 12px;border:none;border-radius:6px;cursor:pointer;font-weight:bold}
    .btn-green{background:#28a745;color:white}
    .btn-red{background:#dc3545;color:white}
    .btn-gray{background:#6c757d;color:white}
    .btn-blue{background:#007bff;color:white}
    .btn-yellow{background:#ffc107;color:black}
    input{padding:8px;border-radius:6px;border:1px solid #ccc}
    .resumo{margin-top:10px;font-weight:bold;text-align:center}
    .total-geral{margin-top:20px;padding:10px;background:#e9ecef;border-radius:8px;font-weight:bold;text-align:center}
    #app, #logoutBtn { display:none; }
    .loginBox{max-width:420px;margin:10px auto;padding:16px;border-radius:8px;background:#fff;border:1px solid #ddd;text-align:center}
    .small {font-size:0.9rem;color:#666}
  </style>
</head>
<body>
  <div class="container">
    <h1>Planilha de Pagamentos</h1>

    <!-- Login -->
    <div id="loginBox" class="loginBox">
      <h2>Entrar para sincronizar</h2>
      <input id="email" type="email" placeholder="E-mail" style="width:90%;margin:6px 0"><br>
      <input id="password" type="password" placeholder="Senha" style="width:90%;margin:6px 0"><br>
      <div class="controls">
        <button class="btn-green" id="btnSignIn">Entrar</button>
        <button class="btn-blue" id="btnSignUp">Criar conta</button>
        <button class="btn-gray" id="btnGoogle">Entrar com Google</button>
      </div>
      <p class="small">Se preferir nÃ£o entrar, a planilha funciona localmente (sem sincronizar entre aparelhos).</p>
    </div>

    <!-- App -->
    <div id="app">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
        <h2 id="mesAtual"></h2>
        <div>
          <button id="logoutBtn" class="btn-red">Sair</button>
        </div>
      </div>

      <div class="controls">
        <button class="btn-blue" id="mudarMesBtn">Mudar MÃªs</button>
        <button class="btn-yellow" id="exportPdfBtn">Exportar PDF</button>
        <button class="btn-yellow" id="exportXlsBtn">Exportar Excel</button>
      </div>

      <h2>Gastos Fixos</h2>
      <div class="controls">
        <input type="text" id="nomeFixo" placeholder="DescriÃ§Ã£o">
        <input type="number" id="valorFixo" placeholder="Valor">
        <button class="btn-green" id="addFixo">Adicionar Fixo</button>
      </div>
      <table id="fixosTable"><thead><tr><th>DescriÃ§Ã£o</th><th>Valor</th><th>Status</th><th>AÃ§Ãµes</th></tr></thead><tbody></tbody></table>
      <div id="resumoFixos" class="resumo"></div>

      <h2>Gastos VariÃ¡veis</h2>
      <div class="controls">
        <input type="text" id="nomeVar" placeholder="DescriÃ§Ã£o">
        <input type="number" id="valorVar" placeholder="Valor">
        <button class="btn-green" id="addVar">Adicionar VariÃ¡vel</button>
      </div>
      <table id="variaveisTable"><thead><tr><th>DescriÃ§Ã£o</th><th>Valor</th><th>Status</th><th>AÃ§Ãµes</th></tr></thead><tbody></tbody></table>
      <div id="resumoVariaveis" class="resumo"></div>

      <div id="totalGeral" class="total-geral"></div>
      <footer style="margin-top:20px;text-align:center;color:#555">Desenvolvido por Phablo Salazar - 2025</footer>
    </div>
  </div>

  <!-- libs para export (pdf/excel) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- Firebase (ES modules via CDN). Substitua abaixo pelo seu config -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js';
    import {
      getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword,
      GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged
    } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js';
    import {
      getFirestore, doc, setDoc, getDoc, onSnapshot
    } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js';

    // ====== COLE AQUI O SEU firebaseConfig (do console Firebase) ======
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT",
      // demais campos (storageBucket, messagingSenderId, appId) se existirem
    };
    // ==================================================================

    // Inicializa Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    // ELEMENTOS
    const loginBox = document.getElementById('loginBox');
    const appDiv = document.getElementById('app');
    const logoutBtn = document.getElementById('logoutBtn');

    // botÃµes e inputs
    document.getElementById('btnSignIn').onclick = signIn;
    document.getElementById('btnSignUp').onclick = signUp;
    document.getElementById('btnGoogle').onclick = signInWithGoogle;
    document.getElementById('logoutBtn').onclick = signOutUser;

    document.getElementById('addFixo').onclick = adicionarFixo;
    document.getElementById('addVar').onclick = adicionarVariavel;
    document.getElementById('mudarMesBtn').onclick = mudarMes;
    document.getElementById('exportPdfBtn').onclick = exportarPDF;
    document.getElementById('exportXlsBtn').onclick = exportarExcel;

    // Dados locais / fallback
    let dados = { mes: new Date().getMonth(), ano: new Date().getFullYear(), fixos: [], variaveis: [] };
    let userDocRef = null;
    let unsubscribeSnapshot = null;

    // localStorage fallback: carrega antes de qualquer login (para usar local sem nuvem)
    const LS_KEY = "pagamentos_local";
    function salvarLocal() { localStorage.setItem(LS_KEY, JSON.stringify(dados)); }
    function carregarLocal() {
      const a = localStorage.getItem(LS_KEY);
      if (a) dados = JSON.parse(a);
    }
    carregarLocal();

    // Render
    function renderizar() {
      document.getElementById("mesAtual").innerText = `MÃªs Atual: ${nomeMes(dados.mes)} / ${dados.ano}`;
      renderizarTabela("fixosTable", dados.fixos, "resumoFixos");
      renderizarTabela("variaveisTable", dados.variaveis, "resumoVariaveis");
      atualizarTotalGeral();
    }

    function renderizarTabela(id, lista, resumoId) {
      let tbody = document.querySelector(`#${id} tbody`);
      tbody.innerHTML = "";
      let totalPago = 0, totalPendente = 0;
      lista.forEach((item, i) => {
        let valor = parseFloat(item.valor) || 0;
        if (item.pago) totalPago += valor; else totalPendente += valor;
        let row = `<tr class="${item.pago ? 'paid':'unpaid'}">
          <td contenteditable="true" onblur="editarDescricao('${id}', ${i}, this.innerText)">${item.nome}</td>
          <td contenteditable="true" onblur="editarValor('${id}', ${i}, this.innerText)">${formatarMoeda(item.valor)}</td>
          <td>${item.pago ? 'Pago':'Pendente'}</td>
          <td>
            <button class="btn-green" onclick="marcarPago('${id}', ${i})">âœ”</button>
            <button class="btn-red" onclick="desfazerPago('${id}', ${i})">â†©</button>
            <button class="btn-gray" onclick="excluirItem('${id}', ${i})">ðŸ—‘</button>
          </td>
        </tr>`;
        tbody.innerHTML += row;
      });
      document.getElementById(resumoId).innerText =
        `Total Pago: ${formatarMoeda(totalPago)} | Pendente: ${formatarMoeda(totalPendente)}`;
    }

    function atualizarTotalGeral() {
      let totalPago = 0, totalPendente = 0;
      [...dados.fixos, ...dados.variaveis].forEach(item => {
        let valor = parseFloat(item.valor) || 0;
        if (item.pago) totalPago += valor; else totalPendente += valor;
      });
      document.getElementById("totalGeral").innerText =
        `TOTAL GERAL â†’ Pago: ${formatarMoeda(totalPago)} | Pendente: ${formatarMoeda(totalPendente)}`;
    }

    // AÃ§Ãµes CRUD â€” apÃ³s cada alteraÃ§Ã£o, salvamos (local ou na nuvem)
    function adicionarFixo() {
      let nome = document.getElementById("nomeFixo").value;
      let valor = document.getElementById("valorFixo").value;
      if (!nome || !valor) return;
      dados.fixos.push({ nome, valor: parseFloat(valor), pago: false });
      afterChange();
      document.getElementById("nomeFixo").value = "";
      document.getElementById("valorFixo").value = "";
    }

    function adicionarVariavel() {
      let nome = document.getElementById("nomeVar").value;
      let valor = document.getElementById("valorVar").value;
      if (!nome || !valor) return;
      dados.variaveis.push({ nome, valor: parseFloat(valor), pago: false });
      afterChange();
      document.getElementById("nomeVar").value = "";
      document.getElementById("valorVar").value = "";
    }

    function marcarPago(id, i) {
      let lista = id === "fixosTable" ? dados.fixos : dados.variaveis;
      lista[i].pago = true;
      afterChange();
    }
    function desfazerPago(id, i) {
      let lista = id === "fixosTable" ? dados.fixos : dados.variaveis;
      lista[i].pago = false;
      afterChange();
    }
    function excluirItem(id, i) {
      let lista = id === "fixosTable" ? dados.fixos : dados.variaveis;
      lista.splice(i, 1);
      afterChange();
    }
    window.editarDescricao = function(id, i, texto) {
      let lista = id === "fixosTable" ? dados.fixos : dados.variaveis;
      lista[i].nome = texto;
      afterChange();
    }
    window.editarValor = function(id, i, texto) {
      let valor = parseFloat(texto.replace("R$", "").replace(",", "."));
      if (isNaN(valor)) return;
      let lista = id === "fixosTable" ? dados.fixos : dados.variaveis;
      lista[i].valor = valor;
      afterChange();
    }

    function afterChange() {
      renderizar();
      if (userDocRef) saveToFirestore();
      else salvarLocal();
    }

    function mudarMes() {
      dados.mes = (dados.mes + 1) % 12;
      if (dados.mes === 0) dados.ano++;
      dados.fixos.forEach(f => f.pago = false);
      dados.variaveis = [];
      afterChange();
    }

    function nomeMes(num) {
      return ["Janeiro","Fevereiro","MarÃ§o","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"][num];
    }
    function formatarMoeda(valor) {
      return parseFloat(valor || 0).toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
    }

    // ===== Firebase: salvar/ler/sincronizar =====
    async function saveToFirestore() {
      if (!userDocRef) return;
      try {
        await setDoc(userDocRef, { dados }, { merge: true }); // grava/mescla o objeto
      } catch (e) {
        console.error("Erro gravando no Firestore:", e);
      }
    }

    async function signUp() {
      const email = document.getElementById('email').value;
      const pass = document.getElementById('password').value;
      try {
        const userCred = await createUserWithEmailAndPassword(auth, email, pass);
        // Ao criar, salvamos local -> nuvem (se houver dados locais)
        await afterSignIn(userCred.user.uid);
      } catch (e) { alert("Erro ao criar conta: "+e.message); }
    }

    async function signIn() {
      const email = document.getElementById('email').value;
      const pass = document.getElementById('password').value;
      try {
        const userCred = await signInWithEmailAndPassword(auth, email, pass);
        await afterSignIn(userCred.user.uid);
      } catch (e) { alert("Erro ao entrar: "+e.message); }
    }

    async function signInWithGoogle() {
      try {
        const userCred = await signInWithPopup(auth, provider);
        await afterSignIn(userCred.user.uid);
      } catch (e) { alert("Erro no Login Google: "+e.message); }
    }

    async function afterSignIn(uid) {
      // referÃªncia ao documento do usuÃ¡rio
      userDocRef = doc(db, 'users', uid);

      // Se existir dados locais (localStorage) e nÃ£o existir documento na nuvem, subimos local -> nuvem
      try {
        const snap = await getDoc(userDocRef);
        if (snap.exists()) {
          // nuvem tem dados â†’ usar nuvem (fonte da verdade)
          const cloud = snap.data().dados;
          if (cloud) {
            dados = cloud;
            salvarLocal(); // atualiza local
          }
        } else {
          // nÃ£o existe na nuvem â†’ cria com os dados locais atuais
          await setDoc(userDocRef, { dados });
        }
      } catch (e) { console.error("Erro ao sincronizar pÃ³s-login:", e); }

      // Inscrever em mudanÃ§as em tempo real
      if (unsubscribeSnapshot) unsubscribeSnapshot();
      unsubscribeSnapshot = onSnapshot(userDocRef, (docSnap) => {
        if (docSnap.exists()) {
          const remote = docSnap.data().dados;
          // apenas atualiza se diferente (evita loops desnecessÃ¡rios)
          if (JSON.stringify(remote) !== JSON.stringify(dados)) {
            dados = remote;
            salvarLocal();
            renderizar();
          }
        }
      });

      // Mostra app
      showApp();
    }

    function signOutUser() {
      signOut(auth).then(() => {
        // limpar referÃªncia e mostrar login
        if (unsubscribeSnapshot) unsubscribeSnapshot();
        userDocRef = null;
        unsubscribeSnapshot = null;
        showLogin();
      });
    }

    // Monitora estado de autenticaÃ§Ã£o
    onAuthStateChanged(auth, (user) => {
      if (user) {
        // usuÃ¡rio jÃ¡ logado (ex: ao abrir o site)
        afterSignIn(user.uid);
      } else {
        // nenhum usuÃ¡rio logado â†’ mostra login, mas mantÃ©m dados locais
        showLogin();
        renderizar();
      }
    });

    // Mostra/oculta:
    function showLogin() {
      loginBox.style.display = "block";
      appDiv.style.display = "none";
      logoutBtn.style.display = "none";
    }
    function showApp() {
      loginBox.style.display = "none";
      appDiv.style.display = "block";
      logoutBtn.style.display = "inline-block";
      renderizar();
    }

    // Export PDF / Excel (usa o objeto `dados`)
    function exportarPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text(`Planilha de Pagamentos - ${nomeMes(dados.mes)}/${dados.ano}`, 14, 15);
      const todasTabelas = [
        { titulo: "Gastos Fixos", dados: dados.fixos },
        { titulo: "Gastos VariÃ¡veis", dados: dados.variaveis }
      ];
      let y = 25;
      todasTabelas.forEach(secao => {
        doc.text(secao.titulo, 14, y);
        y += 5;
        let corpo = secao.dados.map(i => [i.nome, formatarMoeda(i.valor), i.pago ? "Pago":"Pendente"]);
        doc.autoTable({ head: [["DescriÃ§Ã£o","Valor","Status"]], body: corpo, startY: y });
        y = doc.lastAutoTable.finalY + 10;
      });
      doc.text(document.getElementById("totalGeral").innerText, 14, y + 10);
      doc.save(`Planilha_${dados.ano}_${dados.mes+1}.pdf`);
    }

    function exportarExcel() {
      let wb = XLSX.utils.book_new();
      let fixos = dados.fixos.map(i => ({DescriÃ§Ã£o: i.nome, Valor: i.valor, Status: i.pago ? "Pago":"Pendente"}));
      let variaveis = dados.variaveis.map(i => ({DescriÃ§Ã£o: i.nome, Valor: i.valor, Status: i.pago ? "Pago":"Pendente"}));
      let ws1 = XLSX.utils.json_to_sheet(fixos);
      let ws2 = XLSX.utils.json_to_sheet(variaveis);
      XLSX.utils.book_append_sheet(wb, ws1, "Fixos");
      XLSX.utils.book_append_sheet(wb, ws2, "VariÃ¡veis");
      XLSX.writeFile(wb, `Planilha_${dados.ano}_${dados.mes+1}.xlsx`);
    }

    // inicial render
    renderizar();
  </script>
</body>
</html>
